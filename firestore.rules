
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is an admin.
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users
    match /users/{userId} {
      // Admins can read any user profile, and users can read their own.
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      // Any authenticated user can create a user document (on signup).
      allow create: if request.auth != null;
      // No one can update or delete users from the client.
      allow update, delete: if false; 
    }
    
    // Hotels
    match /hotels/{hotelId} {
      // Anyone can read hotel data.
      allow read: if true;
      // Only owners can create hotels.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
      // Owners and admins can update hotels.
      allow update: if request.auth != null && (request.auth.uid == resource.data.ownerId || isAdmin());
      
      // Rooms subcollection
      match /rooms/{roomId} {
          allow read: if true;
          // Owners and admins can manage rooms.
          allow write: if request.auth != null && (get(/databases/$(database)/documents/hotels/$(hotelId)).data.ownerId == request.auth.uid || isAdmin());
      }
      
      // Menu Items subcollection
      match /menuItems/{menuItemId} {
          allow read: if true;
          // Owners and admins can manage menu items.
          allow write: if request.auth != null && (get(/databases/$(database)/documents/hotels/$(hotelId)).data.ownerId == request.auth.uid || isAdmin());
      }
    }

    // Orders
    match /orders/{orderId} {
        // Any authenticated user can create an order.
        allow create: if request.auth != null;
        // Customers, owners, and admins can read orders.
        allow read: if request.auth != null && (request.auth.uid == resource.data.customerId || request.auth.uid == resource.data.ownerId || isAdmin());
        // Only admins can update an order's status.
        allow update: if isAdmin();
    }
    
    // Withdrawals
    match /withdrawals/{withdrawalId} {
        // Owners can create withdrawal requests for themselves.
        allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
        // Owners and Admins can read withdrawal requests.
        allow read: if request.auth != null && (request.auth.uid == resource.data.ownerId || isAdmin());
        // Only admins can update (approve/deny) a request.
        allow update: if isAdmin();
    }
  }
}
